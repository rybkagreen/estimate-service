#!/usr/bin/env node

/**
 * Simple Estimate Service MCP Server with DeepSeek R1
 * –ü—Ä–æ—Å—Ç–æ–π MCP —Å–µ—Ä–≤–µ—Ä —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π DeepSeek R1
 */

import { Server } from '@modelcontextprotocol/sdk/server/index.js';
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';
import {
  CallToolRequestSchema,
  ListToolsRequestSchema,
} from '@modelcontextprotocol/sdk/types.js';
import { deepSeekService } from './services/deepseek.service.js';
import { logger } from './utils/logger.js';

/**
 * Tool handlers
 */
async function handleAnalyzeCode(args: any) {
  try {
    const { code, context = '', language = 'typescript' } = args;

    logger.info(`üîç Analyzing ${language} code (${code.length} chars)`);

    const fullContext = context || `Analyzing ${language} code for the Estimate Service project`;
    const analysis = await deepSeekService.analyzeCode(code, fullContext);

    return {
      content: [
        {
          type: 'text' as const,
          text: `# üîç Code Analysis Results\n\n${analysis}`,
        },
      ],
    };
  } catch (error) {
    logger.error('‚ùå Code analysis error:', error);

    return {
      content: [
        {
          type: 'text' as const,
          text: `‚ùå Error analyzing code: ${error instanceof Error ? error.message : 'Unknown error'}`,
        },
      ],
      isError: true,
    };
  }
}

async function handleGenerateDocs(args: any) {
  try {
    const { code, type = 'function' } = args;

    logger.info(`üìö Generating documentation for ${type}`);

    const documentation = await deepSeekService.generateDocumentation(code, type);

    return {
      content: [
        {
          type: 'text' as const,
          text: `# üìö Generated Documentation\n\n${documentation}`,
        },
      ],
    };
  } catch (error) {
    logger.error('‚ùå Documentation generation error:', error);

    return {
      content: [
        {
          type: 'text' as const,
          text: `‚ùå Error generating documentation: ${error instanceof Error ? error.message : 'Unknown error'}`,
        },
      ],
      isError: true,
    };
  }
}

async function handleGenerateTests(args: any) {
  try {
    const { code, framework = 'jest', testType = 'unit' } = args;

    logger.info(`üß™ Generating ${testType} tests with ${framework}`);

    const tests = await deepSeekService.generateTests(code, framework);

    return {
      content: [
        {
          type: 'text' as const,
          text: `# üß™ Generated Tests (${framework})\n\n${tests}`,
        },
      ],
    };
  } catch (error) {
    logger.error('‚ùå Test generation error:', error);

    return {
      content: [
        {
          type: 'text' as const,
          text: `‚ùå Error generating tests: ${error instanceof Error ? error.message : 'Unknown error'}`,
        },
      ],
      isError: true,
    };
  }
}

async function handleRefactorCode(args: any) {
  try {
    const { code, goals = [] } = args;

    logger.info(`üîß Refactoring code with goals: ${goals.join(', ')}`);

    const refactoredCode = await deepSeekService.refactorCode(code, goals);

    return {
      content: [
        {
          type: 'text' as const,
          text: `# üîß Refactored Code\n\n${refactoredCode}`,
        },
      ],
    };
  } catch (error) {
    logger.error('‚ùå Code refactoring error:', error);

    return {
      content: [
        {
          type: 'text' as const,
          text: `‚ùå Error refactoring code: ${error instanceof Error ? error.message : 'Unknown error'}`,
        },
      ],
      isError: true,
    };
  }
}

async function handleArchitectureAdvice(args: any) {
  try {
    const { description, constraints = [], domain = 'fullstack' } = args;

    logger.info(`üèóÔ∏è Getting architecture advice for ${domain} domain`);

    const advice = await deepSeekService.architectureAdvice(description, constraints);

    return {
      content: [
        {
          type: 'text' as const,
          text: `# üèóÔ∏è Architecture Advice\n\n${advice}`,
        },
      ],
    };
  } catch (error) {
    logger.error('‚ùå Architecture advice error:', error);

    return {
      content: [
        {
          type: 'text' as const,
          text: `‚ùå Error getting architecture advice: ${error instanceof Error ? error.message : 'Unknown error'}`,
        },
      ],
      isError: true,
    };
  }
}

async function handleChat(args: any) {
  try {
    const { message, context = '', temperature = 0.3 } = args;

    logger.info(`üí¨ Chat with DeepSeek R1: ${message.slice(0, 50)}...`);

    const messages = [
      {
        role: 'system' as const,
        content: context || 'You are an AI assistant helping with software development for the Estimate Service project.',
      },
      {
        role: 'user' as const,
        content: message,
      },
    ];

    const response = await deepSeekService.chat(messages, { temperature });

    return {
      content: [
        {
          type: 'text' as const,
          text: `# üí¨ DeepSeek R1 Response\n\n${response}`,
        },
      ],
    };
  } catch (error) {
    logger.error('‚ùå Chat error:', error);

    return {
      content: [
        {
          type: 'text' as const,
          text: `‚ùå Error in chat: ${error instanceof Error ? error.message : 'Unknown error'}`,
        },
      ],
      isError: true,
    };
  }
}

async function handleHealthCheck(args: any) {
  try {
    logger.info('üè• Running DeepSeek R1 health check');
    const result = await deepSeekService.healthCheck();

    return {
      content: [
        {
          type: 'text' as const,
          text: `# üè• DeepSeek R1 Health Check\n\n**Status:** ${result.status}\n**Message:** ${result.message}\n${result.latency ? `**Latency:** ${result.latency}ms` : ''}`,
        },
      ],
    };
  } catch (error) {
    logger.error('‚ùå Health check error:', error);

    return {
      content: [
        {
          type: 'text' as const,
          text: `‚ùå Health check failed: ${error instanceof Error ? error.message : 'Unknown error'}`,
        },
      ],
      isError: true,
    };
  }
}

/**
 * Main server setup
 */
async function main() {
  const server = new Server(
    {
      name: 'estimate-service-mcp-simple',
      version: '1.0.0',
    },
    {
      capabilities: {
        tools: {},
      },
    },
  );

  // DeepSeek tools list handler
  server.setRequestHandler(ListToolsRequestSchema, async () => {
    return {
      tools: [
        {
          name: 'deepseek_analyze_code',
          description: '–ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ —Å –ø–æ–º–æ—â—å—é DeepSeek R1',
          inputSchema: {
            type: 'object' as const,
            properties: {
              code: { type: 'string', description: '–ö–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞' },
              context: { type: 'string', description: '–ö–æ–Ω—Ç–µ–∫—Å—Ç –∞–Ω–∞–ª–∏–∑–∞' },
              language: { type: 'string', enum: ['typescript', 'javascript', 'react', 'nestjs'], description: '–Ø–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è' },
            },
            required: ['code'],
          },
        },
        {
          name: 'deepseek_generate_docs',
          description: '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —Å –ø–æ–º–æ—â—å—é DeepSeek R1',
          inputSchema: {
            type: 'object' as const,
            properties: {
              code: { type: 'string', description: '–ö–æ–¥ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è' },
              type: { type: 'string', enum: ['function', 'class', 'component', 'api'], description: '–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏' },
            },
            required: ['code'],
          },
        },
        {
          name: 'deepseek_generate_tests',
          description: '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤ —Å –ø–æ–º–æ—â—å—é DeepSeek R1',
          inputSchema: {
            type: 'object' as const,
            properties: {
              code: { type: 'string', description: '–ö–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤' },
              framework: { type: 'string', enum: ['jest', 'vitest', 'playwright'], description: '–¢–µ—Å—Ç–æ–≤—ã–π —Ñ—Ä–µ–π–º–≤–æ—Ä–∫' },
              testType: { type: 'string', enum: ['unit', 'integration', 'e2e'], description: '–¢–∏–ø —Ç–µ—Å—Ç–æ–≤' },
            },
            required: ['code'],
          },
        },
        {
          name: 'deepseek_refactor_code',
          description: '–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∫–æ–¥–∞ —Å –ø–æ–º–æ—â—å—é DeepSeek R1',
          inputSchema: {
            type: 'object' as const,
            properties: {
              code: { type: 'string', description: '–ö–æ–¥ –¥–ª—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞' },
              goals: { type: 'array', items: { type: 'string' }, description: '–¶–µ–ª–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞' },
            },
            required: ['code'],
          },
        },
        {
          name: 'deepseek_architecture_advice',
          description: '–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –æ—Ç DeepSeek R1',
          inputSchema: {
            type: 'object' as const,
            properties: {
              description: { type: 'string', description: '–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏' },
              constraints: { type: 'array', items: { type: 'string' }, description: '–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è' },
              domain: { type: 'string', enum: ['frontend', 'backend', 'fullstack', 'database', 'devops'], description: '–û–±–ª–∞—Å—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏' },
            },
            required: ['description'],
          },
        },
        {
          name: 'deepseek_chat',
          description: '–û–±—â–µ–Ω–∏–µ —Å DeepSeek R1',
          inputSchema: {
            type: 'object' as const,
            properties: {
              message: { type: 'string', description: '–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è DeepSeek R1' },
              context: { type: 'string', description: '–ö–æ–Ω—Ç–µ–∫—Å—Ç –±–µ—Å–µ–¥—ã' },
              temperature: { type: 'number', minimum: 0, maximum: 1, description: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏' },
            },
            required: ['message'],
          },
        },
        {
          name: 'deepseek_health_check',
          description: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ DeepSeek R1',
          inputSchema: {
            type: 'object' as const,
            properties: {},
            required: [],
          },
        },
      ],
    };
  });

  // Call tools handler
  server.setRequestHandler(CallToolRequestSchema, async (request) => {
    const { name, arguments: args } = request.params;

    switch (name) {
      case 'deepseek_analyze_code':
        return await handleAnalyzeCode(args);

      case 'deepseek_generate_docs':
        return await handleGenerateDocs(args);

      case 'deepseek_generate_tests':
        return await handleGenerateTests(args);

      case 'deepseek_refactor_code':
        return await handleRefactorCode(args);

      case 'deepseek_architecture_advice':
        return await handleArchitectureAdvice(args);

      case 'deepseek_chat':
        return await handleChat(args);

      case 'deepseek_health_check':
        return await handleHealthCheck(args);

      default:
        throw new Error(`Unknown tool: ${name}`);
    }
  });

  const transport = new StdioServerTransport();

  await server.connect(transport);

  logger.info('üöÄ Simple Estimate Service MCP Server with DeepSeek R1 started successfully');
}

main().catch((error) => {
  logger.error('‚ùå MCP Server failed to start:', error);
  process.exit(1);
});
