#!/usr/bin/env node

/**
 * Simple Estimate Service MCP Server with DeepSeek R1
 * –ü—Ä–æ—Å—Ç–æ–π MCP —Å–µ—Ä–≤–µ—Ä —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π DeepSeek R1
 */

import { Server } from '@modelcontextprotocol/sdk/server/index.js';
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';
import {
    CallToolRequestSchema,
    ListToolsRequestSchema,
} from '@modelcontextprotocol/sdk/types.js';
import { deepSeekService } from './services/deepseek.service.js';
import { logger } from './utils/logger.js';
import { startMetricsServer } from './utils/metrics-server.js';

/**
 * DeepSeek R1 tools definitions
 */
const DEEPSEEK_TOOLS = [
  {
    name: 'deepseek_analyze_code',
    description: '–ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ —Å –ø–æ–º–æ—â—å—é DeepSeek R1',
    inputSchema: {
      type: 'object',
      properties: {
        code: { type: 'string', description: '–ö–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞' },
        context: { type: 'string', description: '–ö–æ–Ω—Ç–µ–∫—Å—Ç –∞–Ω–∞–ª–∏–∑–∞' },
        language: { type: 'string', enum: ['typescript', 'javascript', 'react', 'nestjs'], description: '–Ø–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è' }
      },
      required: ['code']
    }
  },
  {
    name: 'deepseek_generate_docs',
    description: '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —Å –ø–æ–º–æ—â—å—é DeepSeek R1',
    inputSchema: {
      type: 'object',
      properties: {
        code: { type: 'string', description: '–ö–æ–¥ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è' },
        type: { type: 'string', enum: ['function', 'class', 'component', 'api'], description: '–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏' }
      },
      required: ['code']
    }
  },
  {
    name: 'deepseek_generate_tests',
    description: '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤ —Å –ø–æ–º–æ—â—å—é DeepSeek R1',
    inputSchema: {
      type: 'object',
      properties: {
        code: { type: 'string', description: '–ö–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤' },
        framework: { type: 'string', enum: ['jest', 'vitest', 'playwright'], description: '–¢–µ—Å—Ç–æ–≤—ã–π —Ñ—Ä–µ–π–º–≤–æ—Ä–∫' },
        testType: { type: 'string', enum: ['unit', 'integration', 'e2e'], description: '–¢–∏–ø —Ç–µ—Å—Ç–æ–≤' }
      },
      required: ['code']
    }
  },
  {
    name: 'deepseek_refactor_code',
    description: '–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∫–æ–¥–∞ —Å –ø–æ–º–æ—â—å—é DeepSeek R1',
    inputSchema: {
      type: 'object',
      properties: {
        code: { type: 'string', description: '–ö–æ–¥ –¥–ª—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞' },
        goals: { type: 'array', items: { type: 'string' }, description: '–¶–µ–ª–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞' }
      },
      required: ['code']
    }
  },
  {
    name: 'deepseek_architecture_advice',
    description: '–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –æ—Ç DeepSeek R1',
    inputSchema: {
      type: 'object',
      properties: {
        description: { type: 'string', description: '–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏' },
        constraints: { type: 'array', items: { type: 'string' }, description: '–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è' },
        domain: { type: 'string', enum: ['frontend', 'backend', 'fullstack', 'database', 'devops'], description: '–û–±–ª–∞—Å—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏' }
      },
      required: ['description']
    }
  },
  {
    name: 'deepseek_chat',
    description: '–û–±—â–µ–Ω–∏–µ —Å DeepSeek R1',
    inputSchema: {
      type: 'object',
      properties: {
        message: { type: 'string', description: '–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è DeepSeek R1' },
        context: { type: 'string', description: '–ö–æ–Ω—Ç–µ–∫—Å—Ç –±–µ—Å–µ–¥—ã' },
        temperature: { type: 'number', minimum: 0, maximum: 1, description: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏' }
      },
      required: ['message']
    }
  },
  {
    name: 'deepseek_health_check',
    description: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ DeepSeek R1',
    inputSchema: {
      type: 'object',
      properties: {},
      required: []
    }
  }
];

/**
 * Frontend integration tools definitions
 */
const FRONTEND_TOOLS = [
  {
    name: 'deepseek_generate_react_component',
    description: 'Generate React components with TypeScript, Tailwind CSS, and tests',
    inputSchema: {
      type: 'object',
      properties: {
        componentName: { type: 'string', description: 'Name of the React component to generate' },
        description: { type: 'string', description: 'Description of component functionality' },
        props: { type: 'array', items: { type: 'string' }, description: 'Component props' },
        styling: { type: 'string', enum: ['tailwind', 'css-modules'], description: 'Styling approach' },
        includeTests: { type: 'boolean', description: 'Include unit tests' }
      },
      required: ['componentName', 'description']
    }
  },
  {
    name: 'deepseek_generate_api_route',
    description: 'Generate API routes for Next.js with validation and documentation',
    inputSchema: {
      type: 'object',
      properties: {
        routePath: { type: 'string', description: 'API route path' },
        method: { type: 'string', enum: ['GET', 'POST', 'PUT', 'DELETE'], description: 'HTTP method' },
        description: { type: 'string', description: 'API functionality description' },
        framework: { type: 'string', enum: ['nextjs', 'express'], description: 'Backend framework' }
      },
      required: ['routePath', 'description']
    }
  },
  {
    name: 'deepseek_create_ui_design_system',
    description: 'Create design system components with variants and documentation',
    inputSchema: {
      type: 'object',
      properties: {
        componentType: { type: 'string', description: 'Type of UI component' },
        variants: { type: 'array', items: { type: 'string' }, description: 'Component variants' },
        theme: { type: 'string', enum: ['replit', 'material', 'custom'], description: 'Design theme' }
      },
      required: ['componentType']
    }
  },
  {
    name: 'deepseek_optimize_frontend_performance',
    description: 'Optimize frontend code for better Core Web Vitals and performance',
    inputSchema: {
      type: 'object',
      properties: {
        code: { type: 'string', description: 'Frontend code to optimize' },
        focusArea: { type: 'string', enum: ['general', 'loading', 'runtime', 'bundle-size'], description: 'Optimization focus' },
        targetMetrics: { type: 'array', items: { type: 'string' }, description: 'Target metrics' }
      },
      required: ['code']
    }
  }
];

/**
 * Tool handlers
 */
async function handleAnalyzeCode(args: any) {
  try {
    const { code, context = '', language = 'typescript' } = args;
    logger.info(`üîç Analyzing ${language} code (${code.length} chars)`);

    const fullContext = context || `Analyzing ${language} code for the Estimate Service project`;
    const analysis = await deepSeekService.analyzeCode(code, fullContext);

    return {
      content: [
        {
          type: 'text',
          text: `# üîç Code Analysis Results\n\n${analysis}`
        }
      ]
    };
  } catch (error) {
    logger.error('‚ùå Code analysis error:', error);
    return {
      content: [
        {
          type: 'text',
          text: `‚ùå Error analyzing code: ${error instanceof Error ? error.message : 'Unknown error'}`
        }
      ],
      isError: true
    };
  }
}

async function handleGenerateDocs(args: any) {
  try {
    const { code, type = 'function' } = args;
    logger.info(`üìö Generating documentation for ${type}`);

    const documentation = await deepSeekService.generateDocumentation(code, type);

    return {
      content: [
        {
          type: 'text',
          text: `# üìö Generated Documentation\n\n${documentation}`
        }
      ]
    };
  } catch (error) {
    logger.error('‚ùå Documentation generation error:', error);
    return {
      content: [
        {
          type: 'text',
          text: `‚ùå Error generating documentation: ${error instanceof Error ? error.message : 'Unknown error'}`
        }
      ],
      isError: true
    };
  }
}

async function handleGenerateTests(args: any) {
  try {
    const { code, framework = 'jest', testType = 'unit' } = args;
    logger.info(`üß™ Generating ${testType} tests with ${framework}`);

    const tests = await deepSeekService.generateTests(code, framework);

    return {
      content: [
        {
          type: 'text',
          text: `# üß™ Generated Tests (${framework})\n\n${tests}`
        }
      ]
    };
  } catch (error) {
    logger.error('‚ùå Test generation error:', error);
    return {
      content: [
        {
          type: 'text',
          text: `‚ùå Error generating tests: ${error instanceof Error ? error.message : 'Unknown error'}`
        }
      ],
      isError: true
    };
  }
}

async function handleRefactorCode(args: any) {
  try {
    const { code, goals = [] } = args;
    logger.info(`üîß Refactoring code with goals: ${goals.join(', ')}`);

    const refactoredCode = await deepSeekService.refactorCode(code, goals);

    return {
      content: [
        {
          type: 'text',
          text: `# üîß Refactored Code\n\n${refactoredCode}`
        }
      ]
    };
  } catch (error) {
    logger.error('‚ùå Code refactoring error:', error);
    return {
      content: [
        {
          type: 'text',
          text: `‚ùå Error refactoring code: ${error instanceof Error ? error.message : 'Unknown error'}`
        }
      ],
      isError: true
    };
  }
}

async function handleArchitectureAdvice(args: any) {
  try {
    const { description, constraints = [], domain = 'fullstack' } = args;
    logger.info(`üèóÔ∏è Getting architecture advice for ${domain} domain`);

    const advice = await deepSeekService.architectureAdvice(description, constraints);

    return {
      content: [
        {
          type: 'text',
          text: `# üèóÔ∏è Architecture Advice\n\n${advice}`
        }
      ]
    };
  } catch (error) {
    logger.error('‚ùå Architecture advice error:', error);
    return {
      content: [
        {
          type: 'text',
          text: `‚ùå Error getting architecture advice: ${error instanceof Error ? error.message : 'Unknown error'}`
        }
      ],
      isError: true
    };
  }
}

async function handleChat(args: any) {
  try {
    const { message, context = '', temperature = 0.3 } = args;
    logger.info(`üí¨ Chat with DeepSeek R1: ${message.slice(0, 50)}...`);

    const messages = [
      {
        role: 'system' as const,
        content: context || 'You are an AI assistant helping with software development for the Estimate Service project.'
      },
      {
        role: 'user' as const,
        content: message
      }
    ];

    const response = await deepSeekService.chat(messages, { temperature });

    return {
      content: [
        {
          type: 'text',
          text: `# üí¨ DeepSeek R1 Response\n\n${response}`
        }
      ]
    };
  } catch (error) {
    logger.error('‚ùå Chat error:', error);
    return {
      content: [
        {
          type: 'text',
          text: `‚ùå Error in chat: ${error instanceof Error ? error.message : 'Unknown error'}`
        }
      ],
      isError: true
    };
  }
}

async function handleHealthCheck(args: any) {
  try {
    logger.info('üè• Running DeepSeek R1 health check');
    const result = await deepSeekService.healthCheck();

    return {
      content: [
        {
          type: 'text',
          text: `# üè• DeepSeek R1 Health Check\n\n**Status:** ${result.status}\n**Message:** ${result.message}\n${result.latency ? `**Latency:** ${result.latency}ms` : ''}`
        }
      ]
    };
  } catch (error) {
    logger.error('‚ùå Health check error:', error);
    return {
      content: [
        {
          type: 'text',
          text: `‚ùå Health check failed: ${error instanceof Error ? error.message : 'Unknown error'}`
        }
      ],
      isError: true
    };
  }
}

/**
 * Universal handler for frontend tools
 */
async function handleFrontendTool(toolType: string, args: any) {
  try {
    let prompt = '';
    let result = '';

    switch (toolType) {
      case 'generate_react_component':
        const { componentName, description, props = [], styling = 'tailwind', includeTests = true } = args;
        if (!componentName || !description) {
          throw new Error('Component name and description are required');
        }

        logger.info(`üé® Generating React component: ${componentName}`);

        prompt = `–°–æ–∑–¥–∞–π React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç "${componentName}":
–û–ø–∏—Å–∞–Ω–∏–µ: ${description}
Props: ${props.join(', ') || '–±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö props'}
–°—Ç–∏–ª–∏–∑–∞—Ü–∏—è: ${styling}
${includeTests ? '–í–∫–ª—é—á–∏ unit —Ç–µ—Å—Ç—ã' : ''}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- TypeScript —Å —Å—Ç—Ä–æ–≥–æ–π —Ç–∏–ø–∏–∑–∞—Ü–∏–µ–π
- Tailwind CSS –∫–ª–∞—Å—Å—ã
- React —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- Accessibility (a11y)
- JSDoc –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
${includeTests ? '- Unit —Ç–µ—Å—Ç—ã —Å React Testing Library' : ''}`;
        break;

      case 'generate_api_route':
        const { routePath, method = 'POST', description: apiDescription, framework = 'nextjs' } = args;
        if (!routePath || !apiDescription) {
          throw new Error('Route path and description are required');
        }

        logger.info(`üîó Generating API route: ${method} ${routePath}`);

        prompt = `–°–æ–∑–¥–∞–π API route –¥–ª—è ${framework}:
–ü—É—Ç—å: ${routePath}
–ú–µ—Ç–æ–¥: ${method}
–û–ø–∏—Å–∞–Ω–∏–µ: ${apiDescription}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- TypeScript —Ç–∏–ø–∏–∑–∞—Ü–∏—è
- Error handling
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- Proper HTTP status codes
- Security best practices`;
        break;

      case 'create_ui_design_system':
        const { componentType = 'button', variants = ['primary', 'secondary'], theme = 'replit' } = args;

        logger.info(`üé® Creating UI design system: ${componentType}`);

        prompt = `–°–æ–∑–¥–∞–π –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç "${componentType}" –≤ —Å—Ç–∏–ª–µ ${theme}:
–í–∞—Ä–∏–∞–Ω—Ç—ã: ${variants.join(', ')}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- TypeScript –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
- Tailwind CSS –∫–ª–∞—Å—Å—ã
- Accessibility compliance
- Hover, focus, active —Å–æ—Å—Ç–æ—è–Ω–∏—è
- Responsive design
- JSDoc –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è`;
        break;

      case 'optimize_frontend_performance':
        const { code, focusArea = 'general', targetMetrics = ['LCP', 'FID', 'CLS'] } = args;
        if (!code) {
          throw new Error('Code is required for performance optimization');
        }

        logger.info(`‚ö° Optimizing frontend performance: ${focusArea}`);

        prompt = `–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç –∫–æ–¥ –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

–§–æ–∫—É—Å: ${focusArea}
–¶–µ–ª–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏: ${targetMetrics.join(', ')}

\`\`\`typescript
${code}
\`\`\`

–ü—Ä–µ–¥–ª–æ–∂–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏:
- Code splitting –∏ lazy loading
- –ú–µ–º–æ–∏–∑–∞—Ü–∏—è (React.memo, useMemo, useCallback)
- Bundle size optimization
- Image optimization
- Core Web Vitals —É–ª—É—á—à–µ–Ω–∏—è`;
        break;

      default:
        throw new Error(`Unknown frontend tool: ${toolType}`);
    }

    const messages = [
      {
        role: 'system' as const,
        content: '–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è React/TypeScript/Next.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π. –°–æ–∑–¥–∞–≤–∞–π production-ready –∫–æ–¥ —Å –ª—É—á—à–∏–º–∏ –ø—Ä–∞–∫—Ç–∏–∫–∞–º–∏.'
      },
      {
        role: 'user' as const,
        content: prompt
      }
    ];

    result = await deepSeekService.chat(messages, { temperature: 0.3 });

    return {
      content: [
        {
          type: 'text',
          text: `# üé® Frontend Tool: ${toolType}\n\n${result}`
        }
      ]
    };
  } catch (error) {
    logger.error(`‚ùå Frontend tool error (${toolType}):`, error);
    return {
      content: [
        {
          type: 'text',
          text: `‚ùå Error in ${toolType}: ${error instanceof Error ? error.message : 'Unknown error'}`
        }
      ],
      isError: true
    };
  }
}

/**
 * Main server setup
 */
async function main() {
  // Start metrics server
  startMetricsServer();
  
  const server = new Server(
    {
      name: 'estimate-service-mcp-simple',
      version: '1.0.0',
      description: 'Simple MCP server for Estimate Service with DeepSeek R1 integration',
    }
  );

  // List tools
  server.setRequestHandler(ListToolsRequestSchema, async () => {
    return { tools: [...DEEPSEEK_TOOLS, ...FRONTEND_TOOLS] };
  });

  // Call tools
  server.setRequestHandler(CallToolRequestSchema, async (request) => {
    const { name, arguments: args } = request.params;

    switch (name) {
      case 'deepseek_analyze_code':
        return await handleAnalyzeCode(args);
      case 'deepseek_generate_docs':
        return await handleGenerateDocs(args);
      case 'deepseek_generate_tests':
        return await handleGenerateTests(args);
      case 'deepseek_refactor_code':
        return await handleRefactorCode(args);
      case 'deepseek_architecture_advice':
        return await handleArchitectureAdvice(args);
      case 'deepseek_chat':
        return await handleChat(args);
      case 'deepseek_health_check':
        return await handleHealthCheck(args);

      // Frontend integration tools
      case 'deepseek_generate_react_component':
        return await handleFrontendTool('generate_react_component', args);
      case 'deepseek_generate_api_route':
        return await handleFrontendTool('generate_api_route', args);
      case 'deepseek_create_ui_design_system':
        return await handleFrontendTool('create_ui_design_system', args);
      case 'deepseek_optimize_frontend_performance':
        return await handleFrontendTool('optimize_frontend_performance', args);

      default:
        throw new Error(`Unknown tool: ${name}`);
    }
  });

  const transport = new StdioServerTransport();
  await server.connect(transport);

  logger.info('üöÄ Simple Estimate Service MCP Server with DeepSeek R1 started successfully');
  const allTools = [...DEEPSEEK_TOOLS, ...FRONTEND_TOOLS];
  logger.info(`üìã Available tools (${allTools.length}): ${allTools.map(t => t.name).join(', ')}`);
}

main().catch((error) => {
  logger.error('‚ùå MCP Server failed to start:', error);
  process.exit(1);
});
