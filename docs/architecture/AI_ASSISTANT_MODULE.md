# AI Assistant Module Documentation

## Обзор

AI Assistant Module - это интегрированный модуль в составе Estimate Service, предоставляющий интеллектуальные возможности для работы со сметами и строительными задачами.

## Архитектура модуля

```
ai-assistant/
├── services/                    # Основные сервисы
│   ├── task-planner.service.ts      # Планирование и приоритизация задач
│   ├── response-builder.service.ts  # Построение структурированных ответов
│   ├── historical-estimate.service.ts # Анализ исторических данных
│   ├── claude-validator.service.ts  # Валидация с помощью Claude AI
│   ├── fallback-handler.service.ts  # Обработка ошибок и fallback стратегии
│   ├── model-manager.service.ts     # Управление AI моделями
│   └── index.ts                     # Экспорт сервисов
├── controllers/                 # API контроллеры
│   └── task-planner.controller.ts   # REST API для планировщика задач
├── interfaces/                  # Типы и интерфейсы
│   └── ai-task.interface.ts         # Определение типов задач
├── providers/                   # AI провайдеры
│   ├── deepseek-ai.provider.ts      # Интеграция с DeepSeek
│   ├── yandex-ai.provider.ts        # Интеграция с Yandex AI
│   ├── cached-ai.provider.ts        # Кэширование результатов AI
│   └── ai-provider.interface.ts     # Общий интерфейс провайдеров
├── entities/                    # Сущности данных
│   └── ai-feedback.entity.ts        # Обратная связь от пользователей
├── ai-assistant.service.ts      # Основной сервис модуля
├── ai-assistant.controller.ts   # Основной контроллер
└── ai-assistant.module.ts       # Определение модуля NestJS
```

## Основные компоненты

### 1. TaskPlannerService

**Назначение:** Интеллектуальное планирование и приоритизация задач на основе естественного языка.

**Возможности:**
- Распознавание типов задач из текстовых запросов
- Приоритизация задач по важности
- Анализ зависимостей между задачами
- Пакетное выполнение связанных задач

**Поддерживаемые типы задач:**
- `CALCULATION` - Расчеты стоимости и количества
- `COMPARISON` - Сравнение материалов и вариантов
- `VALIDATION` - Проверка соответствия нормам
- `REPORT` - Формирование отчетов и документов

### 2. ResponseBuilderService

**Назначение:** Формирование структурированных и валидированных ответов.

**Функции:**
- Структурирование данных для ответов
- Валидация полноты ответа
- Добавление контекстной информации
- Форматирование для различных типов клиентов

### 3. HistoricalEstimateService

**Назначение:** Анализ исторических данных для улучшения качества рекомендаций.

**Возможности:**
- Поиск похожих смет в истории
- Анализ трендов цен
- Выявление типичных паттернов
- Рекомендации на основе прошлого опыта

### 4. ClaudeValidatorService

**Назначение:** Валидация и улучшение ответов с помощью Claude AI.

**Функции:**
- Проверка фактической корректности
- Оценка полноты ответа
- Выявление потенциальных ошибок
- Предложения по улучшению

### 5. FallbackHandlerService

**Назначение:** Обработка ошибок и реализация резервных стратегий.

**Стратегии:**
- `retry` - Повторная попытка с улучшенным контекстом
- `alternative_model` - Переключение на другую AI модель
- `human_review` - Эскалация для ручной проверки
- `degraded_response` - Упрощенный ответ при недоступности AI

### 6. ModelManagerService

**Назначение:** Управление различными AI провайдерами и моделями.

**Поддерживаемые провайдеры:**
- DeepSeek R1 - основной провайдер
- Yandex AI - альтернативный провайдер
- Cached - кэширование результатов

## API Endpoints

### Task Planning API

```typescript
// Планирование задач на основе запроса
POST /api/ai/tasks/plan
{
  "query": "Рассчитай стоимость фундамента для дома 10x12 метров",
  "projectId": "project-123",
  "userId": "user-456"
}

// Выполнение конкретной задачи
POST /api/ai/tasks/execute
{
  "taskId": "task-789"
}

// Пакетное выполнение плана задач
POST /api/ai/tasks/batch-execute
{
  "tasks": [...],
  "totalEstimatedTime": 300,
  "createdAt": "2025-01-07T10:00:00Z"
}

// Получение примеров запросов
GET /api/ai/tasks/examples
```

## Примеры использования

### 1. Расчеты

```
Запрос: "Рассчитай стоимость кирпичной кладки 100 м²"
Тип задачи: CALCULATION
Приоритет: 80
```

### 2. Сравнения

```
Запрос: "Сравни газобетон и керамзитобетон для строительства дома"
Тип задачи: COMPARISON
Приоритет: 70
```

### 3. Валидация

```
Запрос: "Проверь соответствует ли толщина стены 380мм нормам СНиП"
Тип задачи: VALIDATION
Приоритет: 90
```

### 4. Отчеты

```
Запрос: "Сформируй смету на строительство бани 6x4"
Тип задачи: REPORT
Приоритет: 60
```

## Конфигурация

### Переменные окружения

```env
# AI Providers
DEEPSEEK_API_KEY=your-deepseek-api-key
YANDEX_API_KEY=your-yandex-api-key
CLAUDE_API_KEY=your-claude-api-key

# Cache
REDIS_HOST=localhost
REDIS_PORT=6379
CACHE_TTL=3600

# Model Configuration
DEFAULT_AI_MODEL=deepseek-r1
FALLBACK_AI_MODEL=yandex-gpt
MAX_RETRY_ATTEMPTS=3
```

## Интеграция с другими модулями

### Estimate Module
- Получение данных о сметах для анализа
- Создание и обновление смет на основе AI рекомендаций

### Cache Module
- Кэширование результатов AI запросов
- Оптимизация производительности

### Classification Module
- Использование AI для классификации работ и материалов
- Улучшение точности категоризации

### Validation Module
- AI-валидация данных смет
- Проверка соответствия нормативам

## Мониторинг и метрики

### Отслеживаемые метрики:
- Количество обработанных задач
- Время выполнения задач
- Успешность выполнения
- Использование fallback стратегий
- Точность AI предсказаний

### Логирование:
- Все запросы к AI провайдерам
- Ошибки и их обработка
- Использование кэша
- Производительность компонентов

## Безопасность

### Защита данных:
- Шифрование API ключей
- Валидация входных данных
- Ограничение частоты запросов
- Аудит доступа к AI функциям

### Приватность:
- Анонимизация пользовательских данных
- Локальное кэширование без передачи третьим лицам
- Соответствие GDPR

## Развитие и планы

### Краткосрочные планы:
- Добавление новых типов задач
- Улучшение точности распознавания
- Оптимизация производительности

### Долгосрочные планы:
- Интеграция с большим количеством AI провайдеров
- Обучение на пользовательских данных
- Автоматическая оптимизация смет
- Предиктивная аналитика
