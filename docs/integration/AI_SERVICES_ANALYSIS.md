# Анализ существующих AI сервисов

## Дата анализа: 2024-01-22

### 1. Структура проекта

В проекте есть 3 AI-связанных компонента:

1. **services/ai-assistant** - отдельный микросервис
2. **services/ai-assistant-service** - новый сервис с DeepSeek R1
3. **services/estimate-service/src/modules/ai-assistant** - модуль внутри estimate-service

### 2. Сервис ai-assistant

**Порт:** 3008

**Структура модулей:**
- **Core** - базовая функциональность AI
- **Knowledge** - управление базой знаний (in-memory реализация)
- **Analytics** - сбор и хранение аналитики
- **Chat** - чат функциональность
- **Auth** - аутентификация
- **Learning** - модуль обучения

**Технологии:**
- NestJS
- Prisma ORM
- Vector Store (для векторного поиска)
- DeepSeek интеграция (базовая)
- Поддержка OpenAI и Claude (в конфигурации)

**Особенности:**
- Использует webpack для сборки
- Конфигурация через project.json (Nx)
- Модульная архитектура

### 3. Сервис ai-assistant-service

**Порт:** 3030

**Структура модулей:**
- **DeepSeek** - полная интеграция с DeepSeek R1
- **Chat** - улучшенный чат модуль
- **Conversation** - управление диалогами
- **Context** - управление контекстом строительной отрасли
- **Health** - health checks
- **Vector Store** - интеграция с Weaviate

**Технологии:**
- NestJS
- Prisma ORM
- Weaviate (векторная БД)
- Redis (кэширование)
- DeepSeek R1 (основной AI движок)
- Helmet и Compression для безопасности

**Конфигурация DeepSeek:**
- Модель: deepseek-r1-2024
- Таймаут: 120 секунд
- Retry логика: 3 попытки
- Специализированные промпты для строительства

### 4. Модуль ai-assistant в estimate-service

**Компоненты:**
- ai-assistant.service.ts - основной сервис
- price-analysis.service.ts - анализ цен
- risk-assessment.service.ts - оценка рисков
- rule-engine.service.ts - движок правил

**Интеграция:**
- Тесно связан с estimate-service
- Использует общие модели данных
- Прямой доступ к БД через Prisma

### 5. Сравнение DeepSeek реализаций

**ai-assistant/deepseek.service.ts:**
- Более расширенный функционал
- Методы: analyzeEstimate, generateEstimate, generateEstimateDescription
- Дополнительные параметры для анализа (regionCode, year, documentType)

**ai-assistant-service/deepseek.service.ts:**
- Более простая реализация
- Базовые методы анализа
- Фокус на стабильности и производительности

### 6. Зависимости и конфликты

**Общие зависимости:**
- @nestjs/* - версии совместимы
- @prisma/client - версия 5.0.0
- axios, class-validator, class-transformer

**Потенциальные конфликты:**
- Порты: 3008 (ai-assistant) vs 3030 (ai-assistant-service)
- Разные подходы к конфигурации (project.json vs package.json)
- Разные векторные БД (общий vector-store vs Weaviate)

### 7. Рекомендации по миграции

#### Безопасные для переноса модули:

1. **DeepSeek сервис из ai-assistant**
   - Более функциональный
   - Специфичные методы для строительства
   - Можно объединить с текущей реализацией

2. **Knowledge модуль**
   - Простая in-memory реализация
   - Можно расширить для работы с Weaviate

3. **Analytics модуль**
   - Независимый модуль
   - Полезен для отслеживания использования

#### Требуют адаптации:

1. **Core модуль**
   - Нужна интеграция с существующей конфигурацией
   - Адаптация под архитектуру ai-assistant-service

2. **Chat модуль**
   - Уже есть в ai-assistant-service
   - Нужно выбрать лучшую реализацию

#### Не рекомендуется переносить:

1. **Auth модуль**
   - У каждого сервиса своя аутентификация
   - Лучше использовать централизованную

### 8. План интеграции

1. **Фаза 1: Подготовка**
   - Создать бэкапы текущих сервисов
   - Документировать API endpoints
   - Подготовить тесты

2. **Фаза 2: Миграция DeepSeek**
   - Объединить функционал обоих DeepSeek сервисов
   - Добавить методы analyzeEstimate, generateEstimate
   - Сохранить retry логику и error handling

3. **Фаза 3: Интеграция модулей**
   - Перенести Knowledge модуль
   - Адаптировать для работы с Weaviate
   - Интегрировать Analytics

4. **Фаза 4: Тестирование**
   - Unit тесты для новых модулей
   - Integration тесты
   - Performance тесты

5. **Фаза 5: Деплой**
   - Поэтапный переход
   - Мониторинг производительности
   - Откат при необходимости

### 9. Выводы

- Оба сервиса имеют ценные компоненты
- ai-assistant имеет более богатый функционал для строительной отрасли
- ai-assistant-service имеет лучшую архитектуру и безопасность
- Рекомендуется объединить лучшее из обоих сервисов
- Основной риск - конфликты зависимостей и архитектурные различия
