# AI Assistant Module - TaskPlannerService

## Описание

TaskPlannerService - это сервис для интеллектуального планирования и выполнения задач на основе естественного языка. Сервис анализирует пользовательские запросы, разбивает их на подзадачи, определяет зависимости и приоритеты, а затем выполняет их в оптимальном порядке.

## Основные возможности

1. **Разбор естественного языка** - понимание запросов на русском языке
2. **Классификация задач** - автоматическое определение типа задачи
3. **Приоритизация** - умная система приоритетов с учетом типа задачи
4. **Управление зависимостями** - автоматическое определение порядка выполнения
5. **Интеграция с сервисами** - подключение к EstimateCalculator, Material и Norm сервисам

## Типы задач

### CALCULATION (Расчеты)
- Расчет стоимости материалов и работ
- Определение необходимого количества материалов
- Вычисление затрат и расходов

### COMPARISON (Сравнения)
- Сравнение материалов
- Поиск альтернатив
- Выбор оптимального варианта

### VALIDATION (Проверки)
- Проверка соответствия нормам (СНиП, ГОСТ)
- Валидация допустимости использования
- Контроль соответствия стандартам

### REPORT (Отчеты)
- Формирование смет
- Создание отчетов по затратам
- Генерация документации

## API Endpoints

### POST /ai/tasks/plan
Создание плана задач на основе пользовательского запроса.

```typescript
// Request
{
  "query": "Рассчитай стоимость фундамента и проверь соответствие нормам",
  "projectId": "project-123",
  "userId": "user-456"
}

// Response
{
  "tasks": [
    {
      "id": "uuid-1",
      "type": "CALCULATION",
      "description": "Расчет стоимости: фундамента",
      "dependencies": [],
      "priority": 80,
      "status": "pending"
    },
    {
      "id": "uuid-2",
      "type": "VALIDATION",
      "description": "Проверка соответствия нормам",
      "dependencies": ["uuid-1"],
      "priority": 110,
      "status": "pending"
    }
  ],
  "totalEstimatedTime": 1100,
  "createdAt": "2024-01-01T00:00:00Z"
}
```

### POST /ai/tasks/execute
Выполнение конкретной задачи.

```typescript
// Request
{
  "taskId": "uuid-1"
}

// Response
{
  "id": "uuid-1",
  "type": "CALCULATION",
  "status": "completed",
  "result": {
    "type": "calculation",
    "result": "Стоимость фундамента: 450,000 руб",
    "details": { /* ... */ }
  }
}
```

### POST /ai/tasks/batch-execute
Выполнение всего плана задач с учетом зависимостей.

### GET /ai/tasks/examples
Получение примеров запросов для каждого типа задач.

## Использование в коде

### Базовое использование

```typescript
import { TaskPlannerService } from './services/task-planner.service';

// Создание плана задач
const plan = await taskPlannerService.planTasks(
  'Рассчитай стоимость материалов для крыши и сравни металлочерепицу с профнастилом'
);

// Выполнение задач
for (const task of plan.tasks) {
  const result = await taskPlannerService.executeTask(task);
  console.log(`Задача ${task.description}: ${result.status}`);
}
```

### Сложные запросы

```typescript
// Комплексный запрос с множественными задачами
const complexQuery = `
  Рассчитай общую стоимость строительства дома 10x12, 
  проверь соответствие фундамента нормам СНиП, 
  сравни газобетон и керамзитобетон для стен,
  и создай итоговый отчет по смете
`;

const plan = await taskPlannerService.planTasks(complexQuery);
// План будет содержать 4 задачи с правильными зависимостями
```

## Паттерны распознавания

### Расчеты
- "рассчитай стоимость..."
- "посчитай затраты на..."
- "сколько стоит..."
- "определи расход..."

### Сравнения
- "сравни X и Y"
- "что лучше выбрать..."
- "альтернативы для..."
- "варианты материалов..."

### Проверки
- "проверь соответствие нормам..."
- "соответствует ли СНиП..."
- "можно ли использовать..."
- "допустимо ли применение..."

### Отчеты
- "сформируй отчет..."
- "создай смету..."
- "покажи все затраты..."
- "подготовь документ..."

## Приоритеты задач

Базовые приоритеты:
- VALIDATION: 90 (+20 бонус = 110)
- CALCULATION: 80 (+10 если является зависимостью)
- COMPARISON: 70
- REPORT: 60

## Алгоритм работы

1. **Разбор запроса** - разделение на сегменты по разделителям
2. **Извлечение задач** - сопоставление с паттернами
3. **Приоритизация** - очередь с приоритетами
4. **Анализ зависимостей** - определение порядка выполнения
5. **Топологическая сортировка** - финальный порядок задач
6. **Выполнение** - последовательное выполнение с учетом зависимостей

## Расширение функциональности

### Добавление нового типа задачи

1. Добавьте новый тип в `TaskType` enum
2. Создайте паттерны распознавания в `initializeTaskPatterns()`
3. Реализуйте метод выполнения `executeNewType()`
4. Добавьте обработку в `executeTask()`

### Добавление новых паттернов

```typescript
{
  pattern: /ваш регулярное выражение/i,
  type: TaskType.YOUR_TYPE,
  priority: 75,
  extractor: (match) => ({
    description: `Описание: ${match[1]}`,
    data: { /* извлеченные данные */ }
  })
}
```

## Тестирование

```bash
# Запуск тестов
npm test task-planner.service.spec.ts

# Запуск с покрытием
npm test -- --coverage task-planner.service.spec.ts
```

## Примеры интеграции

### С EstimateCalculatorService

```typescript
private async executeCalculation(task: AITask): Promise<any> {
  const estimate = await this.estimateCalculatorService.calculateEstimate({
    projectId: task.data.projectId,
    items: task.data.items
  });
  
  return {
    type: 'calculation',
    result: estimate.total,
    breakdown: estimate.items
  };
}
```

### С MaterialService

```typescript
private async executeComparison(task: AITask): Promise<any> {
  const materials = await this.materialService.findAll({
    where: { name: { in: task.data.items } }
  });
  
  const comparison = materials.map(m => ({
    name: m.name,
    price: m.price,
    properties: m.properties
  }));
  
  return {
    type: 'comparison',
    result: comparison,
    recommendation: this.getBestOption(comparison)
  };
}
```

## Производительность

- Средняя скорость разбора: < 50ms
- Время выполнения задачи: 500-1000ms
- Максимальное количество задач в плане: не ограничено
- Оптимизация: кэширование результатов, параллельное выполнение независимых задач

## Известные ограничения

1. Распознавание только русского языка
2. Ограниченный набор паттернов
3. Простая система зависимостей
4. Отсутствие машинного обучения для улучшения распознавания

## Планы развития

1. Добавление поддержки английского языка
2. Интеграция с LLM для улучшения понимания запросов
3. Параллельное выполнение независимых задач
4. Сохранение истории выполнения
5. Обучение на основе обратной связи
